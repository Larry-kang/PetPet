@{
    ViewData["Title"] = "ç·£åˆ†åŒ¹é…";
}

<style>
    .tinder-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        height: 600px;
        margin: 0 auto;
        perspective: 1000px;
    }

    .tinder-card {
        position: absolute;
        width: 100%;
        height: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.3s ease, opacity 0.3s ease;
        transform-origin: 50% 100%;
    }

    .tinder-card img {
        width: 100%;
        height: 70%;
        object-fit: cover;
    }

    .card-info {
        padding: 20px;
        height: 30%;
        background: linear-gradient(to bottom, rgba(255,255,255,0.9), white);
    }

    .card-actions {
        position: absolute;
        bottom: 20px; /* Floating above info, or below */
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 30px;
        z-index: 10;
    }

    .action-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        font-size: 24px;
        transition: transform 0.2s;
        cursor: pointer;
    }
    
    .btn-pass { background: #fff; color: #ff4b4b; border: 2px solid #ff4b4b; }
    .btn-like { background: #ff4b4b; color: #fff; }
    
    .action-btn:hover { transform: scale(1.1); }

    /* Match Overlay */
    #matchOverlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
    }
    
    .match-avatars {
        display: flex;
        gap: 20px;
        margin: 30px 0;
    }
    
    .match-avatar {
        width: 120px; height: 120px;
        border-radius: 50%;
        border: 4px solid white;
        object-fit: cover;
    }

    .no-cards {
        display: none;
        text-align: center;
        padding-top: 100px;
        color: white;
    }
</style>

<div class="container py-4">
    <div id="stack" class="tinder-container">
        <div class="no-cards" id="noCardsMsg">
            <h3>ğŸ“­ æš«æ™‚æ²’æœ‰å°è±¡äº†</h3>
            <p>è«‹ç¨å¾Œå†ä¾†çœ‹çœ‹å§ï¼</p>
        </div>
        <!-- Cards will be injected here -->
    </div>

    <!-- Actions Bar (Fixed at bottom of container for better UX) -->
    <div class="d-flex justify-content-center mt-4 gap-4">
        <button class="action-btn btn-pass" onclick="handleSwipe(0)">âŒ</button>
        <button class="action-btn btn-like" onclick="handleSwipe(1)">ğŸ’–</button>
    </div>
</div>

<!-- Match Overlay -->
<div id="matchOverlay">
    <h1 class="display-1" style="font-family: 'Damion', cursive; color: #ff6b6b; text-shadow: 0 0 20px white;">It's a Match!</h1>
    <h3 id="matchName" class="mt-3">You and Alice liked each other!</h3>
    
    <div class="match-avatars">
        <img src="/images/default-user.png" class="match-avatar" id="myAvatar">
        <img src="/images/default-user.png" class="match-avatar" id="theirAvatar">
    </div>

    <div class="d-grid gap-3 col-6 mx-auto">
        <a href="#" id="chatLink" class="btn btn-light btn-lg rounded-pill fw-bold text-danger">ğŸ’¬ é–‹å§‹èŠå¤©</a>
        <button class="btn btn-outline-light btn-lg rounded-pill" onclick="closeMatch()">ç¹¼çºŒæ»‘å‹•</button>
    </div>
</div>

@section Scripts {
    <script>
        let candidates = [];
        let currentCardIndex = 0;
        
        // Load Candidates
        async function loadCards() {
            const res = await fetch('/Match/GetCandidates');
            candidates = await res.json();
            
            if (candidates.length === 0) {
                document.getElementById('noCardsMsg').style.display = 'block';
                return;
            }
            
            renderCards();
        }

        function renderCards() {
            const stack = document.getElementById('stack');
            // Render in reverse so the first one is on top (z-index logic needed or just appendOrder)
            // Actually simpler: Render only Top 2 cards (Current and Next) to save DOM
            // For MVP: Render all, hide others or stack them absolute
            
            stack.innerHTML = '<div class="no-cards" id="noCardsMsg"><h3>ğŸ“­ æš«æ™‚æ²’æœ‰å°è±¡äº†</h3><p>è«‹ç¨å¾Œå†ä¾†çœ‹çœ‹å§ï¼</p></div>';
            
            // We iterate backwards to stack z-index correctly (first item last = on top)
            // But simplify: Just absolute position. Last appended is on top.
            // So we reverse the array for display loop
            [...candidates].reverse().forEach((c, index) => {
                const card = document.createElement('div');
                card.className = 'tinder-card';
                card.id = `card-${c.targetMember.email}`;
                card.innerHTML = `
                    <div class="position-absolute top-0 end-0 m-3 badge bg-danger fs-5 shadow" style="z-index:2">
                        ${c.matchScore}% ç·£åˆ†
                    </div>
                    <div class="position-absolute top-0 start-0 m-3 badge bg-dark bg-opacity-75 fs-6 shadow" style="z-index:2">
                        ğŸ”® ${c.ziweiName}
                    </div>
                    <img src="${c.targetMember.photo || '/images/default-user.png'}" alt="${c.targetMember.name}">
                    <div class="card-info">
                        <h3>${c.targetMember.name}, <small class="text-muted">${c.targetMember.cityId == 1 ? "å°åŒ—" : "å…¶ä»–"}</small></h3>
                        <p class="text-muted mb-1 small">${c.ziweiDesc}</p>
                        <p class="text-muted mb-0">
                            ${c.primaryPet ? `<i class="fas fa-paw"></i> ${c.primaryPet.name}` : ''}
                        </p>
                        <div class="mt-2 text-wrap">
                            ${c.matchReasons.map(r => `<span class="badge bg-success bg-opacity-75 me-1">${r}</span>`).join('')}
                        </div>
                    </div>
                `;
                stack.appendChild(card);
            });
        }

        async function handleSwipe(action) { // 0 = Pass, 1 = Like
            if (candidates.length === 0) return;
            
            const current = candidates[0]; // Top card (first in array, last in DOM... wait logic above said last appended is top)
            // Correct Logic:
            // Array: [A, B, C]
            // DOM Append: A, B, C (C is on top of B, B on top of A)
            // So candidates[candidates.length - 1] is the visible one? 
            // Let's align: Array [A, B, C]. We want A to be first. 
            // InnerHTML clear. Append C, B, A. A is Last Child => Top.
            // So Current is candidates[0].
            
            // Visual Animation
            const cardEl = document.getElementById(`card-${current.targetMember.email}`);
            if(!cardEl) return;

            const transform = action === 1 ? 'translate(400px, 50px) rotate(30deg)' : 'translate(-400px, 50px) rotate(-30deg)';
            cardEl.style.transform = transform;
            cardEl.style.opacity = '0';

            // Send to Server
            const formData = new FormData();
            formData.append('targetEmail', current.targetMember.email);
            formData.append('action', action);
            // Add CSRF Token
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            try {
                const res = await fetch('/Match/Swipe', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();

                if (result.isMatch) {
                    showMatch(current);
                }
            } catch (err) {
                console.error(err);
            }

            // Remove from Array & UI
            candidates.shift(); // Remove A
            setTimeout(() => cardEl.remove(), 300);
            
            if (candidates.length === 0) {
                 document.getElementById('noCardsMsg').style.display = 'block';
            }
        }

        function showMatch(target) {
            document.getElementById('matchName').innerText = `You and ${target.targetMember.name} liked each other!`;
            document.getElementById('theirAvatar').src = target.targetMember.photo || '/images/default-user.png';
            document.getElementById('chatLink').href = `/Chat/Index?with=${target.targetMember.email}`;
            
            // Display overlay
            const overlay = document.getElementById('matchOverlay');
            overlay.style.display = 'flex';
            overlay.classList.add('animate__animated', 'animate__zoomIn');
        }

        function closeMatch() {
            document.getElementById('matchOverlay').style.display = 'none';
        }

        loadCards();
    </script>
    @Html.AntiForgeryToken()
}
