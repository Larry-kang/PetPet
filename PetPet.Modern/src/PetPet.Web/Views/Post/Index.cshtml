@{
    ViewData["Title"] = "å¯µç‰©ç¤¾ç¾¤ç‰†";
}

<div class="row mb-4 align-items-center">
    <div class="col-8">
        <h1 class="display-6">ğŸ¾ å¯µç‰©ç¤¾ç¾¤ç‰†</h1>
        <p class="text-muted">å³æ™‚åˆ†äº«æ¯›å­©çš„é»é»æ»´æ»´</p>
    </div>
    <div class="col-4 text-end">
        <a asp-action="Create" class="btn btn-lg btn-success rounded-pill shadow-sm">
            âœï¸ ç™¼ä½ˆè²¼æ–‡
        </a>
    </div>
</div>

<div id="posts-container" class="row g-4">
    <!-- Posts will be loaded here via AJAX -->
</div>

<div class="row mt-5 mb-5">
    <div class="col-12 text-center">
        <div id="loader" class="spinner-border text-primary d-none" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p id="no-more-data" class="text-muted mt-3 d-none">å·²ç¶“åˆ°åº•å›‰ï¼ ğŸ</p>
    </div>
</div>

@section Scripts {
    <script>
        let page = 1;
        const pageSize = 9;
        let isLoading = false;
        const isUserAuthenticated = @(User.Identity.IsAuthenticated.ToString().ToLower());

        function loadPosts() {
            if (isLoading) return;
            
            // Guest Restriction: Only allow loading first page (9 posts)
            if (!isUserAuthenticated && page > 1) {
                showGuestRestriction();
                return;
            }

            isLoading = true;
            $('#btn-load-more').addClass('d-none');
            $('#loader').removeClass('d-none');

            $.get(`/Post/GetPosts?page=${page}&pageSize=${pageSize}`, function(data) {
                if (data.length === 0) {
                    $('#no-more-data').removeClass('d-none');
                    $('#loader').addClass('d-none');
                    return;
                }

                data.forEach(post => {
                    const postHtml = `
                        <div class="col-md-6 col-lg-4">
                            <div class="card glass-card h-100 shadow-sm border-0">
                                <div class="card-header bg-transparent border-0 pt-3 ps-3 d-flex align-items-center">
                                    <img src="${post.author.photo || '/images/default-avatar.png'}" class="rounded-circle me-2 object-fit-cover" width="40" height="40">
                                    <div>
                                        <div class="fw-bold small">${post.author.name}</div>
                                        <div class="text-muted x-small" style="font-size:0.75rem">${new Date(post.createdAt).toLocaleDateString()}</div>
                                    </div>
                                </div>
                                ${post.imageUrl ? `<img src="${post.imageUrl}" class="card-img-top object-fit-cover" style="height: 200px;" alt="Post Image">` : ''}
                                <div class="card-body">
                                    <h5 class="card-title fw-bold fs-6">${post.title}</h5>
                                    <p class="card-text small text-secondary text-truncate-3">${post.content}</p>
                                </div>
                                <div class="card-footer bg-transparent border-0 d-flex justify-content-between align-items-center">
                                    <button class="btn btn-sm ${post.isLiked ? 'btn-danger' : 'btn-outline-danger'} rounded-pill" onclick="toggleLike(${post.id})">
                                        ${post.isLiked ? 'â¤ï¸' : 'ğŸ¤'} ${post.likeCount}
                                    </button>
                                    <small class="text-muted">ğŸ’¬ ${post.commentCount}</small>
                                </div>
                            </div>
                        </div>
                    `;
                    $('#posts-container').append(postHtml);
                });

                // If guest, show restriction immediately after first load implies "Only 1 page allowed"
                // But typically we want them to see 1 page, then try to scroll -> Block.
                // Current logic allows page 1. Next trigger (scroll) will hit page 2 check above.

                page++;
                isLoading = false;
                $('#loader').addClass('d-none');
                $('#btn-load-more').removeClass('d-none');
                
                // If guest, maybe append a blurring overlay at the bottom as a teaser?
                if (!isUserAuthenticated && page > 1) {
                     showGuestRestriction();
                }
            });
        }
        
        function showGuestRestriction() {
            // Remove scroll listener
             $(window).off('scroll');
             $('#loader').addClass('d-none');
             
             if ($('#guest-overlay').length === 0) {
                 const overlay = `
                    <div id="guest-overlay" class="col-12 mt-4">
                        <div class="glass-card p-5 text-center position-relative overflow-hidden">
                             <div class="position-absolute top-0 start-0 w-100 h-100 bg-white" style="opacity:0.3; filter: blur(10px); z-index:0;"></div>
                             <div class="position-relative" style="z-index:1;">
                                <h2 class="fw-bold mb-3">ğŸ”’ ç™»å…¥ä»¥æŸ¥çœ‹æ›´å¤š</h2>
                                <p class="text-muted mb-4">åŠ å…¥ PetPet ç¤¾ç¾¤ï¼Œæ¢ç´¢æ›´å¤šå¯æ„›æ¯›å­©çš„æ—¥å¸¸ï¼</p>
                                <a href="/Member/Login" class="btn btn-primary btn-lg rounded-pill px-5 shadow me-2">ç™»å…¥</a>
                                <a href="/Member/Register" class="btn btn-outline-primary btn-lg rounded-pill px-5 shadow">è¨»å†Š</a>
                             </div>
                        </div>
                    </div>
                 `;
                 $('#posts-container').append(overlay);
                 // Scroll slightly to show it
                 $('html, body').animate({
                    scrollTop: $("#guest-overlay").offset().top - 300
                }, 1000);
             }
        }

        // Initial Load
        $(document).ready(function() {
            loadPosts();

            // Infinite Scroll Logic
            $(window).scroll(function() {
                if($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
                    loadPosts();
                }
            });
            
            // Add Create Post Button Float
            if(isUserAuthenticated) {
                // Remove any previous button
                $('#fab-create-post').remove();
                $('body').append(`
                    <a href="/Post/Create" id="fab-create-post" class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center position-fixed" style="width: 60px; height: 60px; bottom: 30px; right: 30px; z-index: 1000; font-size: 24px;">
                        â•
                    </a>
                `);
            }
        });

        function toggleLike(id) {
            if(!isUserAuthenticated) {
                window.location.href = "/Member/Login";
                return;
            }
            
            $.post(`/Post/Like/${id}`, { __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() }, function(res) {
               if(res.success) {
                   // Find the button and update it
                   // Since we don't have unique ID for button (bad practice in loop above), let's just reload or use target. But for now reloading is disruptive.
                   // Ideally we set ID on button like `btn-like-${id}`.
                   // Let's assume user accepts a simple success alert or re-render.
                   // Proper way:
                   const btn = $(`button[onclick="toggleLike(${id})"]`);
                   btn.html(`${res.isLiked ? 'â¤ï¸' : 'ğŸ¤'} ${res.count}`);
                   btn.toggleClass('btn-danger btn-outline-danger');
               }
            });
        }
    </script>
    <style>
        .text-truncate-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
}
